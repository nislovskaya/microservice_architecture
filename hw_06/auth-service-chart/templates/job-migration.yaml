apiVersion: batch/v1
kind: Job
metadata:
  name: auth-db-migration
  namespace: m
spec:
  template:
    spec:
      containers:
        - name: migrator
          image: postgres:latest
          command: [ "/bin/sh", "-c" ]
          args:
            - |
              psql postgresql://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME -f /migrations/dump.sql
          envFrom:
            - configMapRef:
                name: auth-app-config
            - secretRef:
                name: auth-db-secret
          volumeMounts:
            - name: migrations-volume
              mountPath: /migrations
      volumes:
        - name: migrations-volume
          configMap:
            name: auth-migrations-config
      restartPolicy: OnFailure

---

apiVersion: batch/v1
kind: Job
metadata:
  name: crud-db-migration
  namespace: m
spec:
  template:
    spec:
      containers:
        - name: migrator
          image: postgres:latest
          command: [ "/bin/sh", "-c" ]
          args:
            - |
              psql postgresql://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME -f /migrations/dump.sql
          envFrom:
            - configMapRef:
                name: crud-app-config
            - secretRef:
                name: crud-db-secret
          volumeMounts:
            - name: migrations-volume
              mountPath: /migrations
      volumes:
        - name: migrations-volume
          configMap:
            name: crud-migrations-config
      restartPolicy: OnFailure
